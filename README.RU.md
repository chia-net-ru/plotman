# `plotman`: Менеджер засева Chia
[English](README.md) / [Русский](README.RU.md)

Эта утилита служит для управления засевом [Chia](https://github.com/Chia-Network/chia-blockchain). 
Утилита запускается на сеющей машине и предоставляет следующий функционал:

- Автоматическое создание новых заданий засева, возможно, перекрывающихся ("в шахматном порядке") в нескольких временных каталогах скорость ограничена глобально и для каждого временного каталога.

- Передача на удаленный хост новых участков модулем rsync (фермер/комбайн), называеая "архивированием".

- Мониторинг текущих заданий засева и архивирования, хода выполнения, используемых ресурсов,
временных файлов и т.д.

- Контроль текущих заданий засева (приостановка, возобновление, а также остановка и очистка
временных файлов).

- Оба режима одинаково хороши: как интерактивный режим мониторинга, так и режим управления из командной строки.

- (очень сырой) Анализ статистики производительности прошлых заданий для агрегирования по
различным параметрам засева или типу временной папки.

Plotman предназначен для следующей конфигурации:

- Машина-сеялка с массивом папок `tmp`, одной папкой `tmp2` и
массивом папок `dst`, в которые размещаются готовые поля. Папки `dst` служат
временным буферным пространством для сгенерированных участков.


- Машина-фермер с большим количеством дисков, доступная через модуль
`rsyncd` и полностью заполненная участками. Они известны как каталоги
`archive`.

- Задания засева выполняются с перенаправлением STDOUT/STDERR в файл журнала в указанный
каталог. Это позволяет анализировать прогресс (фазы засева), а также время
(например, для анализа производительности).

## Функциональность

Утилиты Plotman не имеют состояний. Вместо того, чтобы вести запись о том, какие задания
были запущены, Plotman полагается на список запущенных процессов, открытые файлы и файлы
журналов засевов, чтобы понять, "что происходит". Это означает, что инструменты
могут быть остановлены и запущены даже из другого сеанса входа в систему без потери
информации. Это также означает, что Plotman может видеть и управлять заданиями, запущенными вручную
или с помощью других инструментов, при условии, что их STDOUT/STDERR перенаправлены в файл в
известном каталоге файлов журнала. (Примечание: Утилита основана на чтении аргументов командной строки 
исполняемого файла chia и его формата вывода в процессе засева. Изменения в них могут сломать утилиту.)

Планирование засева выполняется путем ожидания определенного количества времени с момента запуска
последнего задания, поиска наилучшей для засева (например, редко используемой) папки `tmp`
и обеспечения того, чтобы задание продвинулось по крайней мере до определенной точки
(например, фаза 2, подфаза 5).

Очевидно, необходимо, чтобы пропускная способность rsync превышала пропускную способность засева.
Учитывая это, при нормальной работе папка `dst` остаётся пустой до тех пор, пока
участок не будет завершен, после чего он вскоре будет подхвачен
заданием архивации. Таким образом, использование дисков `dst` в качестве
буфера, означает, что, если фермер/комбайн или сеть станут 
недоступными, засев полей будет продолжаться непрерывно.

## Screenshot Overview

```
Plotman 19:01:06 (refresh 9s/20s)  |  Plotting: stagger (1623s/1800s) Archival: active pid 1599918
Prefixes:  tmp=/mnt/tmp  dst=/home/chia/chia/plots  archive=/plots (remote)

  #       plot id    k   tmp   dst    wall   phase    tmp       pid   stat      mem    user    sys     io               
  0   6b4e7375...   32    03   001    0:27     1:2    71G   1590196    SLP     5.5G    0:52   0:02     0s
  1   9ab50d0e...   32    02   005    1:00     1:4   199G   1539209    SLP     5.5G    3:50   0:09     0s
  2   018cf561...   32    01   000    1:32     1:5   224G   1530045    SLP     5.5G    4:46   0:11     2s
  3   f771de9c...   32    00   004    2:03     1:5   241G   1524772    SLP     5.5G    5:43   0:14     2s
...
 16   58045bef...   32    10   002   11:23     3:5   193G   1381622    RUN     5.4G   15:02   0:53   0:02
 17   8134a2dd...   32    11   003   11:55     3:6   148G   1372206    RUN     5.4G   15:27   0:57   0:03
 18   50165422...   32    08   001   12:43     3:6   102G   1357782    RUN     5.4G   16:14   1:00   0:03
 19   100df84f...   32    09   005   13:19     4:0      0   1347430    DSK   705.9M   16:44   1:04   0:06

tmp   ready    phases     tmp   ready    phases        dst   plots   GB free         phases         priority 
 00      --   1:5, 3:4     06      --   2:4            000   1       1890      1:5, 2:2, 3:4        47
 01      --   1:5, 3:4     07      --   2:2            001   0       1998      1:2, 1:7, 3:2, 3:6   34
 02      --   1:4, 3:3     08      --   1:7, 3:6       002   0       1967      1:6, 2:5, 3:5        42
 03      --   1:2, 3:2     09      --   2:1, 4:0       003   0       1998      1:6, 3:1, 3:6        34
 04      OK   3:1          10      --   1:6, 3:5       004   0       1998      1:5, 2:4, 3:4        46
 05      OK   2:5          11      --   1:6, 3:6       005   0       1955      1:4, 2:1, 3:3, 4:0   18

Archive dirs free space
000:   94GB | 005:   94GB | 012:   24GB | 017:   99GB | 022:   94GB | 027:   94GB | 032: 9998GB | 037: 9998GB
001:   94GB | 006:   93GB | 013:   25GB | 018:   94GB | 023:   94GB | 028:   94GB | 033: 9998GB |
002:   93GB | 009:   25GB | 014:   93GB | 019:   31GB | 024:   94GB | 029: 7777GB | 034: 9998GB |
003:   94GB | 010:   25GB | 015:   94GB | 020:   47GB | 025:   94GB | 030: 9998GB | 035: 9998GB |
004:   94GB | 011:   25GB | 016:   99GB | 021:   93GB | 026:   94GB | 031: 9998GB | 036: 9998GB |

Log:
01-02 18:33:53 Starting plot job: chia plots create -k 32 -r 8 -u 128 -b 4580 -t /mnt/tmp/03 -2 /mnt/tmp/a -d /home/chi
01-02 18:33:53 Starting archive: rsync --bwlimit=100000 --remove-source-files -P /home/chia/chia/plots/004/plot-k32-202
01-02 18:52:40 Starting archive: rsync --bwlimit=100000 --remove-source-files -P /home/chia/chia/plots/000/plot-k32-202
```

На скриншоте отображены некоторые важные функции Plotman.

В первой строке отображается статус. Статус засева показывает, начался ли засев, 
или, если нет, то почему (например, время задержки, каталоги tmp не готовы и т. д.;
В этом примере время задержки 1800сек между участками еще не достигнуто).
Статус архивации указывает, производится ли мы в настоящее время архивирование (и предоставляет pid
`rsync`) или на дисках `dst` для архивирования нет новых участков.

Вторая строка содержит рашифровку к глобальным аббревиатурам каталогов. 
Для каталогов `tmp` и `dst` мы предполагаем, что они имеют общий префикс, который 
вычисляется и указывается здесь, после чего на них можно ссылаться (в контексте)
по их уникальному суффиксу. Например, если у нас есть `tmp` директории `/mnt/tmp/00`,
`/mnt/tmp/01`, `/mnt/tmp/02` и т.д. Мы указываем `/mnt/tmp` в качестве префикса и 
можем говорить о `tmp` директориях `00` или `01` и т.д. Каталоги `archive` похожи,
за исключением того, что содержат путь на удаленные сетевые машины, доступ к которым
осуществляется через модуль `rsyncd` (см. подробности в `src/plotman/resources/plotman.yaml`).

Далее в таблице приведена информация об активных заданиях засева. Она
сокращена, чтобы показать самые давние и новые запущенные задания (полный список
доступен в режиме командной строки). В нем отображается различная информация о
заданиях участка, включая идентификатор участка (первые 8 символов), используемые каталоги,
время запуска, текущую фазу и подфазу участка, пространство, используемое на диске `tmp`,
`pid` и т.д.

Следующую таблицу немного трудно читать; на самом деле это две таблицы: 
в левой половине экрана находится таблица `tmp`, которая разделена на две таблицы для целей рендеринга,
в правой половине экрана таблица `dst`.  Таблица `tmp` показывает фазы заданий засева использующих 
временный каталог, и то, готовы ли каталоги к выполнению нового задания засева.  В таблице `dst`
показано, сколько готовых участков накопилось, сколько свободного места осталось, а также
этапы заданий, предназначенных для записи в каталог назначения; В конце указан приоритет 
перемещения участков для задания архивирования.

Последня таблица просто показывает свободное место на удаленых харвестерах/фермах

В последней секции отображается журнал выполненных действий -- а именно запущенные 
задания засева и архивации участков. Это одна из частей интерактивной утилиты, которая
отслеживает состояние.  Постоянная запись выполненных действий отсутствует, поэтому, если
вы запустите новый интерактивный сеанс plotman, этот журнал будет пуст.

## Ограничения и проблемы

Прототестировано только на Linux. 
The system is tested on Linux only. Plotman должен быть портирован на другие
платформы, но это еще не сделано. Существуют некоторые проблемы, связанные с вызовом
linux-подобных консольных программ (например, запуск `df` через `ssh`, чтобы получить свободное
пространство на удаленных машинах в каталогах архивов).

Интерактивный режим использует библиотеку `curses` ... плохо. Нажатия
клавиш не принимаются, изменение размера экрана не работает, а минимальный размер терминала
довольно большой.

Plotman предполагает, что все участки являются k32. Опять же, это просто нереализованный
функционал.

Многие функции неконсистентно поддерживаются либо в "интерактивном"
режиме, либо в режиме командной строки.

Есть еще много багов и что необходимо сделать.

Plotman всегда будет искать файл `plotman.yaml` на вашем компьютере в
расположении по умолчанию заданному вашей ОС. Чтобы создать файл `plotman.yaml`, выполните:
```shell
> plotman config generate
```

Чтобы найти текущее расположение вашего `plotman.yaml` и проверить его существование, выполните:
```shell
> plotman config path
```

([See also](https://github.com/ericaltendorf/plotman/pull/61#issuecomment-812967363)).

## Установка

Установка для Linux:

1. Plotman предполагает, что в системе уже установлена [Chia](https://github.com/Chia-Network/chia-blockchain).
   Активируйте среду окружения `chia` набрав
   `source /path/to/your/chia/install/activate`.
2. Затем установите Plotman используя следующую комманду:
   ```shell
    > pip install --force-reinstall git+https://github.com/ericaltendorf/plotman@main
    ```
3. Plotman будет искать `plotman.yaml` на вашем компьютере в папке по умолчанию
   в зависимости от ОС. Чтобы создать такой файл `plotman.yaml` и отобразить его местоположение,
   выполните следующую комманду:
   ```shell
   > plotman config generate
   ```
   Файл конфигурации по умолчанию, используемый в качестве отправной точки, находится [здесь](./src/plotman/resources/plotman.yaml)
4. Вот и всё! Вы можете запустить Plotman набрав `plotman version` для проверки его версии.
   Выполните `plotman --help` для изучения доступных комманд.

### Примечание разработчикам:

Если Вы форкнули Plotman, на шаге установки замените комманду на `pip install --editable .[dev]` из коревой папки проекта для установки *вашей* версии plotman с дополнительными функциями тестирования и разработки.

### Примечание от переводчика:

Перевод выполнен [Chia Russian Community](http://chia.net.ru/). Ошибки и замечания по переводу присылайте администрации Discord сервера [CRC](https://discord.gg/utKCadVSPK)
Оригинальный текст на Английском языке Вы можете найти по адресу [https://github.com/ericaltendorf/plotman](https://github.com/ericaltendorf/plotman)
